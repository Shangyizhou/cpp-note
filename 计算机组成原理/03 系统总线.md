[TOC]



# 系统总线

## 总线的基本概念

计算机系统的五大部件之间的互联方式有两种

- 各部件之间使用单独的连线，称为分散连接
- 各部件连到一组公共信息传输线上，称为总线连接

早期计算机大多采用分散连接，且是以运算器为中心的结构，其内部连线复杂。尤其是当I/O与存储器交换信息时，都需经过运算器，致使运算器停止运算，严重影响了CPU的工作效率

后改进为以存储器为中心的分散连接结构，但是仍无法解决I/O设备与主机之间连接的灵活性。I/O设备的种类数量越来越多，人们希望随时增添删减设备，这就有了总线连接方式

总线：连接多个部件的信息传输线，是各部件共享的传输介质

当多个部件与总线相连时，如果出现两个或两个以上部件同时向总线发送信息，势必导致信号冲突，传输无效。因此，在某一时刻，只允许有一个部件向总线发送信息，而多个部件可以同时从总线上接受相同的信息

总线实际上是由许多传输线或通路组成，每条线可一位一位地传输二进制代码。例如，16条传输线组成的总线可同时传输16位二进制代码

（图3.1）以CPU为中心的双总线结构

![image-20210511142042954](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20210511142042954.png)

M总线（存储总线）：连接CPU和主存

输入/输出总线（I/O总线）各种`I/O`设备通过`I/O`接口挂到`I/O`总线上

（图3.2 单总线结构框图）

![image-20210511142401964](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20210511142401964.png)

特点：当`I/O`设备与主存交换信息时，原则上不影响CPU的工作。因为只有一组总线，当某一时刻各部件都要占用总线时，就会发生冲突，为此必须设置总线判优逻辑

（图3.3 以存储器为中心的双总线结构）

![image-20210511142551312](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20210511142551312.png)

它是在单总线基础上又开辟出的一条CPU与主存之间的总线，称为存储总线。这组总线速度高，只供主存与CPU之间传输信息。提高了传输效率，又减轻了系统总线的负担

## 总线的分类

### 片内总线

片内总线是指芯片内内部的总线，CPU芯片内部，寄存器与寄存器之间，寄存器与算逻辑单怨ALU之间都由片内总线连接

### 系统总线

系统总线是指由CPU、主存、I/O设备各大部件之间的信息传输线

按系统总线传输信息的不同，又可以分为三类：数据总线、地址总线、控制总线

**数据总线**

传输各功能部件之间的数据信息，是`双向传输总线`，其位数与机器字长、存储字长有关，一般8位、16位或32位

**地址总线**

地址总线主要用来指出数据总线上的源数据或目的数据在主存单元的地址或I/O设备的地址

由CPU输出，`单向传输`

**控制总线**

控制总线是用来发出各种控制信号的传输线。还起到监视各部件状态的作用，查询各设备状态

对任一控制线，它的传输时`单向`的，但是对于控制总线总体来说，又可以认为是`双向`的

**常见的控制信号**

- **时钟：**用来同步各种操作

- **复位：**初始化所有部件

- **总线请求：**表示某部件需获得总线使用权

- **总线允许：**表示需要获得总线使用权的部件已获得了控制权

- **中断请求：**表示某部件提出中断请求

- **中断响应：**表示中断请求已被接收

- **存储器写：**将数据总线上的数据写至存储器的指定地址单元内

- **存储器读：**将指存储单元中的数据读到数据总线上

- **I/O读：**从指定的I/O端口将数据读到数据总线上

- **I/O写：**将数据总线上的数据输出到指定的I/O端口内

- **传输响应：**表示数据已被接收，或已将数据送至数据总线上

### 通信总线

这类总线用于计算机系统之间或计算机系统与其它系统之间的通信

串行通信：指数据在单条1位宽的传输线上，一位一位地按顺序分时传送

并行通信：指数据在多条1位宽的传输线上，同时由源传送到目的地

并行通信适宜于近距离的数据传送（传送速率高），串行通信适宜于远距离传送

## 总线特性及性能指标

### 总线特性

总线由许多导线直接印刷在电路板上

![image-20210511144600952](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20210511144600952.png)

- 为了保证机械上的可靠连接，必须规定其机械特性

- 为了确保电器上正确连接，必须规定其电气特性
- 为保证正确地连接不同部件，还需规定其功能特性和时间特性



**机械特性**

指总线在机械连接方式上的一些性能，如插头与插座使用标准，几何尺寸、形装等

**电气特性**

电气特性是指总线的每一根传输线上信号的传递方向和有效的电平范围。通常规定CPU发出的信号称为输出信号，送入CPU的信号为输入信号。

**功能特性**

功能特性是指总线中每根传输线的功能，如地址总线用来指出地址码

**时间特性**

时间特性是指总线中的任一根线在什么时间有效，每条总线上的各种信号互相存在一种有效时序的关系

### 总线性能指标

**总线宽度**

通常是指数组总线的根数，用bit表示，如8位（8根）、16位、32位、64位等

**总线带宽**

可理解为总线的数据传输速率，即**单位时间内总线上传输数据的位数**，通常用每秒传输信息的`字节数`来衡量，单位可用`MBps`来表示

例如，总线工作频率位33MHz，总线宽度位32位（4B），则总线带宽为	`33 *（32 / 8）= 132 MBps`

**时钟同步/异步**

**总线复用**

**信号线数**

**总线控制方式**

**其他指标**

### 总线标准

略

## 总线结构

总线结构通常可分为单总线结构和多总线结构两种

### 单总线结构

略

### 多总线结构

略

### 总线结构举例

略

## 总线控制（重点）

### 总线判优控制

总线上所连接的各类设备，按其对总线有无控制功能可分为主设备（模块）和从设备（模块）

- 主设备对总线有控制权
- 从设备只能响应从主设备发来的总线命令，对总线没有控制权

**例子**

某个主设备想和某个从设备进行通信，首先由主设备发出总线请求命令，若某个主设备同时要使用总线，则就由总线控制器的判优、仲裁逻辑按一定的优先等级顺序确定哪个主设备能使用总线

**只有获得总线使用权的主设备才能开始传送数据**

总线判优控制可分集中式和分布式两种，前者将控制逻辑集中在溢出（如CPU），后者将控制逻辑分散在与总线连接的各个部件或设备上

常见的几种控制优先权仲裁方式有三种

#### 链式查询

用于总线控制的3根线

- BS总线忙
- BR总线请求
- BG总线同意

BG串行地从一个I/O接口送到下一个I/O接口，如果BG到达的接口有总线请求，BG信号不再往下传，该接口获得总线使用权，并建立BS信号，表明占用总线

![image-20210511165952798](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210511165952798.png)

**特点**

- 链式查询中，离总线控制部件最近的设备具有最高的优先级
- 只需很少几根线就能按照一定优先次序实现总线控制，容易扩张设备
- 对电路故障敏感（BG按顺序的查询，其中断掉一个后面就无法查询了），且优先级别低的设备可能很难获得请求

#### 计数器定时查询

与链式查询相比，多了一组地址线，少了一根总线同意线BG

总线控制部件接到由BR送来的总线请求信号后，在总线尾被使用情况下，计数器开始技术，并通过设备地址线，向各设备发出一组地址信号。当某个请求占用总线的设备地址与计数值一样，便获得总线使用权，此时终止计数查询。

**特点**

- 优先次序灵活，可以从0开始，也可以从上一次计数的终点开始（循环）
- 计数器初始值可设置
- 对电路故障不如链式查询那样敏感
- 增加了控制线，控制比较复杂（线多）

#### 独立请求方式

每一台设备均有一对总线请求线BR，和总线同意线BG。当设备要求使用总线时，便发出该设备的请求信号。总线控制部件中有一排队电路，可根据优先次序确定响应哪一台设备的请求。

**特点**

- 响应速度快，优先次序控制灵活
- 控制线数量多，总线控制更复杂（计数器查询大致用）

### 总线通信控制

部件争夺总线使用权时，应按各部件的优先等级来解决。

在通信时间上，则应按分时方式来处理，即以获得总线使用权的先后顺序分时占用总线

通常将完成一次总线操作的时间称为总线周期，分为四个周期

- 申请分配阶段：需使用总线的主设备提出申请，经总线仲裁机构决定下一传输周期的总线使用权授予某一申请者
- 寻址阶段：取得使用权的主设备通过总线发出要访问的从设备的地址及有关命令
- 传数阶段：主模块和从模块进行数据交换，数据由源模块发出，经数据总线流入目的模块
- 结束阶段：主模块的有关信息均从系统总线上撤除，让出总线使用权

总线通信控制主要解决通信双方如何获知传输开始和传输结束，通常有四种方式：同步通信、异步通信、半同步通信和分离式通信

#### 同步通信

同步通信在系统总线设计时，对T1、T2、T3、T4都有明确、唯一的规定

![image-20210511230437326](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210511230437326.png)

对于读命令

- T1 主模块发地址
- T2 从模块读命令
- T3 从模块提供数据
- T4 主模块撤销读命令、从模块撤销数据

对于写命令

- T1 主模块发地址
- T1.5 主模块提供数据
- T2 主模块发出写命令，从模块接收到命令后，必须在规定时间内将数据总线上的数据写到地址总线所指明的单元中
- T4 主模块撤销写命令和数据等信号

![image-20210511230517930](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210511230517930.png)

**特点**

- 规定明确、统一，模块间的配合简单一致
- 主、从模块时间配合属于强制性同步，对各个不同速度的部件而言，必须按最慢速度的部件来设计公共时钟，影响总线工作效率
- 同步通信一般用于总线长度比较短，各部件存取时间比较一致的场合

#### 异步通信

克服了同步通信的缺点，允许各模块速度的不一致，没有公共的始终标准，而是采用了应答的方式（握手）

当主模块发出请求信号时，一致等待从模块反馈回来响应信号后，才开始通信，这要求主、从模块之间增加两条应答线

异步通信的应答方式可分为不互锁、半互锁和全互锁三种形式

![image-20210511215403333](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210511215403333.png)

**不互锁方式**

主模块发出请求信号后，不必等待从模块的回答信号，而是经过一段时间，确认从模块已收到信号后，便撤销其请求信号

从模块接到请求信号后，在条件允许时发出回答信号，并且经过一段时间确认主模块已收到回答信号后，自动撤销回答信号

**半互锁方式**

主模块发出请求信号，必须待接到从模块的回答信号后再撤销其请求信号，有互锁关系

而从模块在接到请求信号后发出回答信号，但不必等待获知主模块的请求信号已经撤销，而是隔一段时间后自动撤销其回答信号，无互锁关系

**全互锁方式**

主模块发出请求信号后，必须待从模块的回答信号后再撤销其请求信号。从模块发出回答信号，必须待获知主模块请求信号已撤销后，再撤销其回答信号。双方存在互锁关系，故称为全互锁方式

#### 半同步通信

半同步通信有同步通信和异步通信的特点

- 所有的地址、命令、数据信号的发出时间，都严格参照系统时钟的某个前沿开始，而接收方都采用系统时钟后沿时刻来进行判断识别

- 允许不同速度的模块和谐的工作

为此增设了一条`WAIT`响应信号线，采用插入时钟（等待）周期的措施来协调通信双方的配合问题



**例子**

在同步通信中，主模块在T1发出地址，在T2发出命令，在T3传输数据，在T4结束传输，倘若从模块工作速度较慢，无法在T3时刻提供数据，则必须在T3到来前通知主模块，给出WAIT（低电平）信号。若主模块在T3到来时刻测得WAIT为低电平，就插入一个等待周期Tw，不立即取数。主模块在下一个时钟周期到来时可又测得WAIT为低，就再插入一个Tw等待，直到WAIT为高电平。

- T1 主模块发出地址信息
- T2 主模块发出命令
- Tw 当WAIT为低电平时，进入等待，Tw的宽度与T的宽度一致
- T3 从模块提供数据
- T4 主模块撤销读命令，从模块撤销数据

![image-20210511222920686](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210511222920686.png)

半同步通信适用于系统工作速度不高但又包含了许多工作速度差异较大的各类设备组成的简单系统

缺点是对系统时钟频率不能要求太高

#### 分离式通信

在之前的通信方式中，从模块按照命令进行读数据的必要准备这个时间段总线纯属空闲等待，我们要利用这段时间提高总线的效率。

基本思想是讲一个传输周期分解为两个子周期，在第一个子周期中，主模块A在获得总线使用权后将各种信息发到系统总线，给从模块B接收下来后，立即放弃总线使用权，一边其他模块使用。在第二个子周期中，B模块收到A模块命令信号后，将A模块数据准备好，由B模块申请总线使用权，将信息送到总线上，由A模块接收

上述两个传输子周期都只有单方向的信息流，每个模块都变成了主模块

- 各模块欲占用总线使用权都必须提出申请
- 在得到总线使用权后，主模块在限定的时间内向对方传送信息，采用同步方式传送，不再等待对方的回答信号
- 各模块在准备数据的过程中都不占用总线，使总线可接受其他模块的请求
- 总线被占用时都在做有效工作，充分利用了总线的有效占用，从而实现了主、从模块间进行信息交叉重叠并行传送，这对大型计算机系统是极为重要的



## 课后题

1、什么是总线？总线传输有何特点？为了减轻总线负载，总线上的部件应具备什么特点？

> 总线是连接多个部件的信息传输线，是各部件共享的传输介质
>
> 总线传输的特点是：某一时刻，只允许有一个部件向总线发送信息，而多个部件可以同时从总线上接收相同的信息
>
> 为了减轻总线负载，总线上的部件应通过三台驱动缓冲电路与总线联通

2、总线如何分类？什么是系统总线？系统总线又分几类？它们各有何作用？是单向的还是双向的？它们与机器字长、存储字长、存储单元有何关系？

> 分类：
>
> 按数据传送方式：并行传输总线、串行传输总线
>
> 并行传输总线中，按传输数据宽度：8位、16位、32位、64位等
>
> 按连接部件的不同：片内总线、系统总线、通信总线

> 系统总线是指CPU、主存、I/O设备各大部件之间的信息传输线
>
> 系统总线，按系统传输信息不同，分：数据总线、地址总线、控制总线
>
> （1）数据总线用来传输各功能部件之间的数据信息，它是双向传输总线，其位数与机器字长、存储字长有关，一般为8位、16位、32位。数据总线的条数成为数据总线带宽，它是衡量系统性能的一个重要参数。如果数据总线的宽度位8位，指令字长为16位，那么CPU在取指阶段，必须两次访问主存
>
> （2）地址总线主要用来指出数据总线上的源数据或目的数据在主存单元的地址或I/O设备的地址，地址总线上的代码是用来指明CPU欲访问的存储单元或I/O端口的地址，由CPU输出，是单向传输。地址线的位数与存储单元的个数有关，如地址线有20根，则对应的存储单元个数为2^20
>
> （3）控制总线是用来发出各种控制信号的传输线，对任一控制线而言，它的传输只能是单向的。总体来看，控制器既有出，也有入

3、常用的总线结构有几种？不同的总线结构对计算机的性能有什么影响？举例说明。

> （1）单总线结构
>
> 单总线结构是将CPU、主存、I/O设备都挂在一条总线上，允许I/O设备之间、I/O设备与CPU之间或I/O设备与主存之间直接交换信息。这种结构简单，也便于扩充，但所有的传送都通过这组共享总线，因此极易形成计算机系统的瓶颈。它也不允许两个以上的部件在同一时刻向总线传输信息，这就必然会影响系统工作效率的提高。计算机应用范围越扩大，其外部设备的种类和数量就越多，并且他们对数据传输的量和传输速度的要求也就越来越高。当I/O设备量很大时，总线发出的控制信号从一端逐个顺序传递到第n个设备，其传播延迟时间就会严重影响系统的工作效率。在设备需要数据量很大和传输速度要求高德时候，单总线结构无法满足需要
>
> （2）多总线结构
>
> 双总线结构：将速度较低的I/O设备从单总线上分离出来，形成主存总线与I/O总线分开的结构
>
> 三总线结构：在双总线结构的基础上加了一条DMA总线，用于高速外设（磁盘等）与主存之间直接交换信息。还有一种三总线结构，在处理器和高速缓冲存储器Cache之间有一条局部总线，Cache连接系统总线，主存通过系统总线和Cache传输数据，扩展总线通过扩展总线接口和系统总线连接，扩展总线连接各种外设。各部件之间的交互分离，可显著提高系统工作效率
> 
>
> 四总线结构：为了进一步提供I/O的性能，使其更快的响应命令，又加了一条高速总线在Cache和扩展总线之间，高速总线负责高速外设的数据传输和控制，(如高速局域网、图形工作站、多媒体SCSI等)。扩展总线依然负责比较低速的设备(如图文传真FAX、调制解调器及串行接口)
>
> 总线结构举例：传统微机总线结构、VL-BUS局部总线结构、PCI总线结构

4、为什么要设置总线判优控制？常见的集中式总线控制有几种？各有何特点？哪种方式响应时间最快？那种方式对电路故障最敏感？

> 多个主设备同时要使用总线时，需要由总线控制器判优，按一定的优先等级顺序，确定哪个主设备能使用总线。
>
> 集中式总线控制类型：
>
> （1）链式查询：
>
> 连线简单，就三根线(BS总线忙、BR总线请求、BG总线同意)，易于扩充，对电路故障最敏感
>
> （2）计数器定时查询：
>
> 优先级设置较灵活，可预设，对故障不敏感，连线及控制过程较复杂，多了一条设备地址线，没有了BG线，由计数器向设备地址线发送信号来控制使用哪个设备
>
> （3）独立请求方式：
>
> 判优速度最快，但硬件器件用量大，连线多，成本较高。每个外设都有自己的BR，BG线

5、解释下列概念：总线的主设备(或主模块)、总线的从设备(或从模块)、总线的传输周期和总线的通信控制

>总线的主设备：指一次总线传输期间，拥有总线控制权的设备(模块)
>
>总线的从设备：指一次总线传输期间，响应主设备发来的总线命令、配合主设备完成传输的设备(模块)
>
>总线的传输周期：总线完成一次完整而可靠的传输所需时间
>
>总线的通信控制：指总线传送过程中双方的时间配合方式

6、试比较同步通信和异步通信

>同步通信：
>
>由统一时钟控制的通信，控制方式简单，灵活性差，当系统中各部件工作速度差异较大时，总线工作效率以最慢的为基准，效率明显下降。适合于速度差别不大的场合
>
>异步通信：
>
>不由统一时钟控制的通信，部件间采用应答方式进行联系，控制方式较同步复杂，灵活性高，当系统中各部件工作速度差异较大时，有利于提高总线工作效率

7、画图说明异步通信中请求与回答有哪几种互锁关系？

> 

8、为什么说半同步通信同时保留了同步通信和异步通信的特点？

> 所有的地址、命令、数据信号的发出时间，都严格参照系统时钟的某个前沿开始，而接收方都采用系统时钟后沿时刻来进行判断识别。同时又像异步通信那样，允许不同速度的模块和谐的工作

9、分离式通信有何特点？主要用于什么系统？

> （1）各模块欲占用总线使用权都必须提出申请
>
> （2）在得到总线使用权后，主模块在限定的时间内向对方传送信息，采用同步方式传送，不再等待对方的回答信号
>
> （3）各模块在准备数据传送的过程中都不占用总线，使总线可以接受其他模块的请求
>
> （4）总线被占用时都在做有效工作，或者通过它发命令，或者通过它传送数据，不存在空闲等待时间，最充分的发挥了总线的		 有效占用
>
> 从而实现了总线为多个主从模块间进行信息交叉重叠并行式传送，这对大型计算机系统是极为重要的。

10、为什么要设置总线标准？你知道目前流行的总线标准有哪些？什么叫plug and play？哪些总线有这一特点？

> 为了使系统设计简化、模块生产批量化，确保其性能稳定，质量可靠，实现可移化，便于维护等，设置了总线标准。
> 目前流行的总线标准有：ISA、EISA、VL—BUS、PCI等，
> plug and play 即插即用，EISA、PCI等具有此功能

11、画一个具有双向传送功能的总线逻辑图。

> 

12、设数据总线上接有A\B\C\D`4`个寄存器，要求使用合适的74系列芯片，完成下列逻辑设计：

（1）设计一个电路，在同一时间实现D->A、D->B和D->C寄存器间的传送

（2）设计一个电路，实现下列操作