[toc]



# 输入输出系统

## 概述

### 输入输出系统的发展

分为四个阶段，**早期阶段**、**接口模块和DMA阶段**、**具有通道结构的阶段**、具有I/O处理机的阶段

**早期阶段**

- I/O设备数量少，与主存交换信息都必须经过CPU（设备少，对CPU其实也还好）
- 每个I/O设备都必须配有一套独立的逻辑电路与CPU连接，实现信息交换，线路十分散乱、庞杂
- 输入输出过程穿插在CPU执行过程之中进行，I/O设备与主机交换信息时，CPU不得不停止各种运算，I/O设备和CPU按串行访问工作
- 每个I/O设备的逻辑控制电路与CPU控制器紧密构成一个不可分割的整体，增添、减少I/O设备非常困难

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210517121228053.png" alt="image-20210517121228053" style="zoom:80%;" />

**接口模块和DMA阶段**

- 每个I/O设备通过接口模块和主机连接，计算机系统采用了总线结构
- 接口中设置有数据通路和控制通路，数据经过接口既起到缓冲作用，又可完成串并变换
- 控制通路用以传送CPU向I/O设备发出的各种控制命令，或使CPU接收来自I/O设备的各种反馈信号，许多接口还能满足中断请求处理的要求，使I/O设备和CPU可以并行工作，提高了CPU效率
- 采用接口技术还可以使多台I/O设备分时占用总线，多台I/O设备之间也可以并行工作
- 缺点：主机与I/O设备交换信息时，CPU要中断现行程序，还不能做到绝对的并行工作

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210517121235004.png" alt="image-20210517121235004" style="zoom:80%;" />

**具有通道结构的阶段**

因为DMA方式的一些问题，大中型计算机系统采用I/O通道的方式来进行数据交换

- 通道用来负责管理I/O设备以及实现主存与I/O设备之间交换信息的部件，可以视为具有特殊功能的处理器
- 有专用的通道指令，能独立执行用通道指令编写的输入输出程序

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210517121241161.png" alt="image-20210517121241161" style="zoom:80%;" />

**具有I/O设备处理机的阶段**

- I/O处理机又称为外围处理机，它基本独立于主机工作
- 具有I/O处理机的输入输出系统与CPU工作的并行性更高，这说明I/O系统对主机来说更具有更大的独立性

### 输入输出系统的组成

输入输出系统由I/O软件和I/O硬件组成

**I/O软件**

- 将用户编制的程序输入主机内
- 将运算结果输送给用户
- 实现输入输出系统与主机工作的协调等

**（1）I/O指令**

- I/O指令是机器指令的一种
- ![image-20210515110952243](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515110952243.png)
- I/O指令可以和其它机器指令的字长一样，但它还能反映CPU与I/O设备交换信息的特点
- 操作码可视为对I/O和其它指令的判别（入访存指令、算逻指令、控制指令等）
- 命令码体现I/O设备的具体操作
- 设备码是多台I/O设备的选择码（设备的地址）

**（2）通道指令**

- 对具有通道的I/O系统专门设置的指令，一般用以指明参与传送的数据组在主存中的首地址
- 指明需要传送的字节数或传送数据组的末地址
- 通道指令可以由管理程序存放在主存的任何地方，由通道从主存中取出并执行

通道指令是通道自身的指令，用来执行I/O操作。而I/O指令是CPU指令系统的一部分，是CPU用来控制输入输出操作的指令

具有通道指令的计算机，一旦CPU执行了启动I/O设备的指令，就由通道来代替CPU对I/O设备的管理

**I/O硬件**

一般包括接口模块和I/O设备两大部分

一个通道可以和一个以上的设备控制器相连，一个设备控制器又可以控制若干台同一类型的设备

![image-20210515111840539](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515111840539.png)

### I/O设备与主机的联系方式

**（1）I/O设备编制方式**

- 将I/O设备码看作地址码，对I/O地址码的编址可采用统一编址或不统一编址两个方式
- 统一编址就是将I/O地址看做是存储器地址的一部分（64K存储空间中划分出8K地址作为I/O设备的地址）
- 不统一编址就是指I/O地址和存储器地址是分开的
- 统一编址占用存储空间，但无需专用的I/O指令，不统一编址不占用主存空间，但需设专门的I/O指令

**（2）设备寻址**

- 对每台设备都赋予一个设备号，启动某一设备，可由I/O指令的设备码字段直接指出该设备的设备号

**（3）传送方式**

- 并行传送方式，n位信息同时从CPU输出至I/O设备或者反向
- 传送速度快，数据线多

**（4）联络方式**

I/O设备与主机之间必须互相了解当时所处的装填，是否可以传送、传送是否已结束等，这就是联络问题

**立即响应方式**

- 对工作速度缓慢的I/O设备，与CPU发生联系时，通常都已使其处于某种等待状态，CPU的I/O指令一到，它们就立刻响应

**异步工作采用应答信号策略**

- I/O设备与主机工作速度不匹配时采用
- 在交换信息前，I/O设备和CPU各自完成自身的任务，一旦出现联络信号，彼此才准备交换信息
- 当CPU将数据输出到I/O接口后，接口立即向I/O设备发出一个“Ready”信号，告诉I/O设备可以从接口内取数据，I/O设备收到信号后，通常立即从接口取出数据，接着向接口回发一个“Strobe”信号，并让接口告诉CPU数据已被取走，CPU还可继续向此接口发送数据
- ![](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515114429138.png)

**同步工作采用同步时标策略**

- 同步工作要求I/O设备和CPU工作速度完全同步

**（5）I/O设备与主机的连接方式**

- 辐射式和总线式（分散连接和总线连接）

### I/O设备与主机信息传送的控制方式

I/O设备与主机交换信息时，共有5种控制方式，程序查询方式、程序中断方式、直接存储器存取方式（DMA）、I/O通道方式、I/O处理机方式，着重前三种

**程序查询方式**

- CPU通过程序不断查询I/O设备是否准备好，若差的I/O设备未准备就绪，继续查询
- 只要一启动I/O设备，CPU便不断查询，从而种植源程序的执行，原地踏步
- I/O设备准备好，CPU从I/O设备一个字一个字的取出，浪费时间

![image-20210515115427473](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515115427473.png)

**程序中断方式**

- CPU在启动I/O设备后，不查询设备是否已准备就绪，继续执行自身程序，当I/O设备准备就绪后，CPU再发出中断请求后才予以相应
- 由图可见，第K条指令执行结束后，CPU响应了I/O设备的请求，中断了现行程序，转至中断服务程序，处理完后又返回到原程序断点处

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515115903089.png" alt="image-20210515115903089" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515115907055.png" alt="image-20210515115907055" style="zoom:80%;" />

**DMA方式**

程序中断方式消除了程序查询方式的“踏步”现象，但是CPU在响应中断请求后，必须停止先行程序而转入中断服务程序，并为了完成I/O设备与主存交换信息，还不得不占用CPU内存的一些寄存器，这同样是对CPU资源的消耗

现在希望I/O设备可以直接与主存交换信息不占用CPU，这就出现了直接存储器存取方式

- DMA方式中，主存与I/O设备之间有一条数据通路，主存与I/O设备交换信息时，无需调用中断服务程序，若出现DMA和CPU同时访问主存，CPU总是将总线占有权给DMA，通常把DMA的这种占有称为窃取或挪用
- DMA窃取周期时，CPU尚能继续作内部操作（CPU一次取好几个指令）

## I/O设备

### 略

## I/O接口

### 概述

接口可以看做两个系统或两个部件之间的交接部分，它既可以是两种硬设备之间的连接电路，也可以是两个软件之间的共同逻辑边界。I/O接口通常是指主机与I/O设备之间设置的一个硬件电路极其相应的软件控制

**设置接口的理由**

- 一台机器配多个I/O设备，它们各自有设备号，通过接口可实现I/O设备的选择
- I/O设备种类多，速度不一样，与CPU速度差别大， 可以通过接口实现数据缓冲，达到速度匹配
- 有些I/O设备可能串行传送数据，而CPU一般为并行传送，通过接口可实现串-并行格式的转换
- I/O设备的输入输出电平可能与CPU输入输出电平不同，通过接口可实现电平转换
- CPU启动I/O设备工作，要向I/O设备发各种控制信号，通过接口可传送控制命令
- I/O设备需将其工作状态及时向CPU报告，通过接口可监视设备的工作状态，保存状态信息给CPU查询

接口和端口概念不同，端口是指接口电路中的一些寄存器，这些寄存器存放数据信息、控制信息和状态信息，相应端口称为数据端口、控制端口、状态端口

若干个端口加上相应的控制逻辑才能组成接口

### 接口的功能和组成

总线连接方式的I/O接口电路

每一台I/O设备都是通过I/O接口挂到系统总线上的

![image-20210515154252343](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515154252343.png)

**总线连接方式的I/O接口电路**

**（1）数据线**

- 数据线是I/O设备与主机之间数据代码的传送线，其根数一般等于存储字长的位数或字符的位数，通常为双向

**（2）设备选择性**

- 设备选择线是用来传送设备码的，它的根数取决于I/O指令中设备码的位数

**（3）命令线**

- 命令线用以传输CPU向设备发出的各种命令信号，是一组单向总线

**（4）状态线**

- 状态线是将I/O设备的状态向主机报告的信号线

**接口的功能和组成**

**（1）选址功能**

- 确定CPU究竟选择哪台设备

**（2）传送命令的功能**

- CPU向I/O设备发出命令时，要求I/O设备能做出响应，故通常在I/O设备中设有存放命令的命令寄存器以及命令译码器

**（3）传送数据的功能**

- 接口中设有数据通路，完成数据传送，数据通路还应具有缓冲功能，即能将数据暂存在接口内，接口中设有数据缓存寄存器

**（4）反映I/O设备工作状态的功能**

- 为了使CPU能及时了解各I/O设备的工作状态，接口内必须设置一些反映设备工作状态的触发器

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515155445499.png" alt="image-20210515155445499" style="zoom:80%;" />														

**接口类型**

**（1）按数据传送方式分类**

- 有并行接口和串行接口两类，并行接口是一个字节或字的所有位同时传送，串行接口是在设备与接口间一位一位传送

**（2）按功能选择的灵活性分类**

- 有可编程接口和不可编程接口两种，可编程接口的功能及操作方式可用程序来改变或选择，不可编程接口可以通过硬连线逻辑来实现

**（3）按通用性分类**

- 有通用接口和专用接口，通用接口可供多种I/O设备使用，专用接口是为某类外设或某用途设置的

**（4）按数据传送的控制方式分类**

- 有程序型接口和DMA型接口，程序型接口用于连接速度较慢的I/O设备，DMA型接口用于连接高速I/O设备

## 程序查询方式

###  程序查询流程

核心问题在于每时每刻不断查询I/O设备是否准备就绪

当I/O设备较多时，CPU需按各个I/O设备的优先级进行逐级查询

为了正确查询，通常需要执行以下3条指令

- 测试指令：用来查询I/O设备是否准备就绪
- 传送指令：当I/O设备已准备就绪时，执行传送指令
- 转移指令：若I/O设备未准备就绪，执行转移指令，转至测试指令，继续测试I/O设备的状态

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515164536411.png" alt="image-20210515164536411" style="zoom:80%;" />

- 这种方式传送数据会占用CPU中寄存器，需要把寄存器内容保护起来
- 用于传送的一般是一批数据，因此需先设置I/O设备与主机交换数据的计数值
- 设置欲传送数据在主存缓冲区的首地址
- CPU启动I/O设备
- 将I/O接口中断设备标志取至CPU并测试I/O设备是否准备就绪，未就绪继续等待，准备就绪时实现传送。对输入而言，准备就绪意味着接口电路中的数据缓冲寄存器已装满欲传送的数据，称为输入缓冲满，CPU即可取走数据。对输出而言，准备就绪意味着接口电路中的数据已背设备取走，故称输出缓冲空
- CPU执行I/O指令，或从I/O接口的数据缓冲寄存器中读出一个数据，或把一个数据写入I/O接口中的数据缓冲寄存器内，同时将接口中的状态标志复位
- 修改主存地址
- 修改计数值
- 判断计数值
- 结束I/O传送

### 程序查询方式的接口电路

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210515165205642.png" alt="image-20210515165205642" style="zoom:80%;" />

## 程序中断方式

