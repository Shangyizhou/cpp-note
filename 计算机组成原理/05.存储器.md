[toC]

## 概述

### 存储器分类

随着技术的发展，CPU的速度得到惊人的提高，而存储器的取数和存数的速度却不能与CPU的提升相匹配，这使得计算机系统的运行速度收到存储器速度的限制

随着I/O设备的增多，如果它们与存储器交换信息都通过CPU来实现，这将大大降低CPU的效率。为此，出现了I/O与存储器的直接存取方式（DMA），**现在存储器基本被认为是计算机系统的核心**

#### 按存储介质分类

存储介质指能寄存0，1两种代码并能区别两种状态的物质或元器件，主要有`半导体器件`、`磁性材料`和`光盘`等

**半导体存储器**

- 由半导体器件组成，现代半导体存储器都用超大规模集成电路支撑芯片
- 体积小、功耗低、获取时间短
- 电源消失，所存储信息消失，`易失性存储器`

**磁表面存储器**

- 在金属或塑料基体的表面涂一层磁性材料作为记录介质，工作时磁层随载磁体高速运转，用磁头在磁层上进行读/写操作
- 按载磁体形状的不同，分为磁盘、磁带和磁鼓
- 因为材料的特质，它们按其剩磁状态的不同而区分0或1
- 剩磁状态不会轻易丢失，这类存储器具有`非易失性`的特点

**磁芯存储器**

- 硬磁材料做成的环状元件，在磁芯中穿有驱动线和读出线，这样可进行读/写操作
- 磁芯属磁性材料，也是不易失的永久记忆存储器
- 体积过大、工艺复杂、功耗太大被半导体存储器取代

**光盘存储器**

- 光盘存储器是应用激光在记录介质上进行读/写的存储器
- 具有`非易失性`的特点
- 由于记录密度高、耐用性好、可靠性高和可互换性强等特点被用于计算机系统

#### 按存取方式分类

可把存储器分为随机存储器、只读存储器、顺序存取存储器和直接存取存储器

**随机存储器（RAM）**

- RAM是一种可读/写存储器
- 任何一个存储单元的内容都可以随机存取，存取时间与存储单元的物理位置无关，主存都采用这种随机存储器
- RAM又分为静态RAM和动态RAM

**只读存储器（ROM）**

- 能对其存储的内容读出，而不能对其重新写入
- 通用用它存放固定不变的程序，常数和汉字字库，甚至用于操作系统的固化
- 随着半导体技术的发展，先后派生出可编程只读存储器（ROM、PROM）、可擦除可编程只读存储器（ROM、EPROM）等

**串行访问存储器**

- 对存储单元进行读/写操作时，需按照其物理位置的先后顺序寻找地址
- 由于其信息所在位置不同、使得读/写时间均不相同

**直接存取存储器**

- 部分串行访问的情况：在对磁盘进行读/写操作时，首先直接址储该存储器中的某个小区域（磁道），然后再顺序寻访（前半段直接访问，后半段串行访问）

![image-20210512104422221](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210512104422221.png)

### 存储器的层次结构

存储器的三个性质指标

- 速度
- 容量
- 价格

一般来说，速度越高，价格越高，容量越大，价格越低，速度越低

![image-20210512104750023](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210512104750023.png)

图中由上至下，价格越来越低，速度越来越慢，容量越来越慢，CPU访问的频度也越来越少

- 寄存器通常制作在CPU内部，直接在内部参与计算，速度最快，价位最高，容量最小
- 主存存放将要参与运行的程序和数据，速度与CPU差距较大
- 为了使主存与CPU更好地匹配，在主存与CPU之间插入了一种比主存速度更快、容量更小的高速缓冲存储器Cache
- 现代计算机也将Cache制作在CPU内
- 磁盘、磁带作为辅助存储器，容量比主存大用于存放暂时未用到的程序和数据文件

**存储系统层次结构**

主要体现在`缓存——主存`和`主存——辅存`这两个存储层次上

![image-20210512105309019](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210512105309019.png)

**缓存——主存层次**

主要解决CPU和主存速度不匹配的问题，CPU近期要用的数据调入缓存，CPU便可以直接从缓存中获取信息，从而提高访存速度。但由于缓存的容量小，因此需不断地将主存的内容调入缓存，使缓存中原来的信息被替换掉

主存和缓存之间的数据调用是由硬件（快）自动完成的，对程序员使透明的

**主存——辅存层次**

主要解决存储系统的容量问题，辅存的速度比主存速度低，而且不能和CPU交换信息，单它的容量比主存大，可以存放大量暂时未用到的信息。当CPU需要用到信息时，再将辅存的内容调入主存，供CPU直接访问

主存和辅存之间的数据调动时由硬件和操作系统共同完成的

**虚拟存储系统**

主存——辅存这一层次随着不断发展，逐渐形成了虚拟存储系统。

解决问题：在程序运行时，则分配给每个程序一定的运行空间，由地址转换部件(硬件或软件)将编程时的地址转换成实际内存的物理地址。如果分配的内存不够，则只调入当前正在运行的或将要运行的程序块（或数据块），其余部分暂时驻留在辅存中。

一个大作业在执行时，其一部分地址空间在主存，另一部分在辅存，当所访问的信息不在主存时，则由操作系统而不是程序员来安排I/O指令，把信息从辅存调入主存。**从效果上来看，好像为用户提供了一个存储容量比实际主存大得多的存储器，用户无需考虑所编程序在主存中是否放得下或放在什么位置等问题。称这种存储器为虚拟存储器**

虚拟存储器只是一个容量非常大的存储器的逻辑模型，不是任何实际的物理存储器。它借助于磁盘等辅助存储器来扩大主存容量，使之为更大或更多的程序所使用。虚拟存储器指的是主存－外存层次，它以透明的方式为用户提供了一个比实际主存空间大得多的程序地址空间。

## 主存储器

### 概述

根据MAR中的地址访问某个存储单元时，还需经过`地址译码`、`驱动`等电路，才能找到所需访问的单元。读出时需经过`读出放大器`，才能将被选中单元的`存储子`送到MDR。写入时，MDR中的数据也必须经过写入电路才能真正写入到被选中的单元

![image-20210513162302212](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513162302212.png)

现代计算机主存都由半导体集成电路构成，驱动器、译码器和读写电路都在存储芯片中，而MAR和MDR制作在CPU芯片内，存储芯片和CPU芯片可通过总线连接

![image-20210513162833955](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513162833955.png)

#### 主存中存储单元地址的分配

- 主存各存储单元的空间位置是由单元地址号表示对，地址总线支持存储单元地址号
- 不同机器存储字长不一样，8位二进制数字为一个字节，所以存储字长都取8的倍数，计算机可按字寻址，也可按字节寻址

**IBM370例子**

字长为32位，可按字寻址，也可按字节寻址

字地址是用该字高位字节的地址来表示，故其字地址是4 的整数倍，用地址码的末两位来区分同一字的4个字节的位置

（“12345678H”，左边是高位，高位字节地址为字地址）

![image-20210513163611514](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513163611514.png)

#### 主存的技术指标

**存储容量**

存储容量指主存能存放二进制代码的总位数，即

存储容量 = 存储单元个数 * 存储字长

或者用字节表示

存储容量 = 存储单元个数 * 存储字长 / 8

**存储速度**

由存取时间和存取周期表示

**存取时间：**

- 指启动一次存储器操作到完成该操作所需的全部时间

存取周期：

- 存储器进行连续两次独立的存储器操作所需的最小间隔时间

存储器带宽：

- 表示单位时间内存储器存取的信息量，可用字节/秒之类表示
- 提高存储器带宽可采用缩短存取周期、增加存储字长、增加存储体的方法

### 半导体存储芯片简介

#### 半导体存储芯片的基本结构

译码驱动能把地址总线送来的地址信号翻译成对应存储单元的选择信号，该信号在读/写电路的配合下完成对被选择单元的读/写操作

读/写操作包括读出放大器和写入电路

![image-20210513164737177](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513164737177.png)

- 地址线单向输入，其位数与芯片容量有关
- 数据线是双向的，位数与芯片可读出或写入的数据位数有关，数据线位数与芯片容量有关

**地址线和数据线的位数共同反映存储芯片的容量**

![image-20210513164916924](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513164916924.png)

控制线主要有读/写控制线与片选线两种

片选线用来选择存储芯片，由于半导体存储器是由许多芯片组成，为此需要用片选信号来确定哪个芯片被选中

#### 半导体存储芯片的译码驱动方式

两种方法

- 线选法
- 重合法

![image-20210513165438634](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513165438634.png)

![image-20210513165414959](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513165414959.png)

#### 随机存取存储器

随机存取存储器按其存储信息的原理不同，可分为静态RAM和动态RAM两种

##### 静态RAM

- 利用触发器工作原理储存信息，信息读出后仍保城原状态，不需要再生
- 电源掉电，原存信息丢失，属于易失性半导体存储器

（1）静态RAM基本单元电路

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170157011.png" alt="image-20210513170157011" style="zoom: 80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170201847.png" alt="image-20210513170201847" style="zoom:80%;" />

（2）静态RAM芯片举例

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170613480.png" alt="image-20210513170613480" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170622071.png" alt="image-20210513170622071" style="zoom:80%;" />



（3）静态RAM读/写时序

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170626181.png" alt="image-20210513170626181" style="zoom:80%;" />





<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513170652840.png" alt="image-20210513170652840" style="zoom:80%;" />

##### 动态RAM

- 靠电容存储信息，电容上存有足够多的电荷表示1，无电荷表示0
- 电容上电荷只维持1~2ms，不掉点也会自动消失，必须在2ms对所有存储单元恢复一次原状态，这个过程称作刷新
- 与静态RAM相比，集成度更高、功耗更低，被各类计算机广泛使用

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513171307652.png" alt="image-20210513171307652" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513171242465.png" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513171246774.png" alt="image-20210513171246774" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513171343794.png" alt="image-20210513171343794" style="zoom:80%;" />

##### 动态RAM和静态RAM比较

- 在同样大小的芯片中，动态RAM的集成度远高于静态RAM，动态RAM的基本单元电路为一个MOS管，静态RAM要4~6个
- 动态RAM行、列地址按陷后顺序输送，减少了芯片引脚，封装尺寸也减少
- 动态RAM的价格便宜，采用同一档次的实现技术时，动态RAM的容量大约是静态RAM容量的4~8倍，静态RAM的存取周期比动态RAM的存取周期快8~16倍，价格也贵8~16倍

#### 只读存储器

按照ROM的原始定义，一旦注入原始信息即不能改变，随着需求变化，出现了PROM、EPROM、EEPROM

##### 掩模ROM

##### PROM

##### EPROM

#### 存储器与CPU的连接

（1）存储容量的扩展

单片存储芯片的容量有限，不满足需求，于是将若干存储芯片连在一起组成足够容量的存储器

分为位扩展和字扩展

**位扩展**

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513172916103.png" alt="image-20210513172916103" style="zoom:80%;" />

![image-20210513172933796](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513172933796.png)

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513172937901.png" alt="image-20210513172937901" style="zoom:80%;" />

（2）字扩展

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513173524858.png" alt="image-20210513173524858" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513173712153.png" alt="image-20210513173712153" style="zoom:80%;" />

（3）字位扩展

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513173904723.png" style="zoom:80%;" />

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210513173910405.png" alt="image-20210513173910405" style="zoom:80%;" />

## 高速缓冲存储器

### 概述

#### （1）问题的提出

在多体并行存储系统中，由于I/O设备向主存请求的级别高于CPU主存，这就出现了CPU等待I/O设备访存的现象，CPU空等待的时间降低了CPU工作效率

为避免CPU与I/O设备争抢访存，可加一级缓层

Cache的出现使CPU可以不直接访问主存，而与高速Cache交换信息

**访问的局部性**

实验发现，CPU从主存取指令或数据，在一定时间内，只是对主存局部地址区域的访问。这是由于指令和数据在主存内部都是连续存放的，并且有些数据和指令往往会被多次调用（子程序、循环程序），**即指令和数据在主存的地址分布不是随机的，而是相对的簇聚，使得CPU执行程序时，访存具有相对的局部性**，这就称为程序访问的局部性（那就把局部的经常访问的调入Cache）

#### （2）Cache的工作原理

主存由2的n次方可编址的字组成，每个字有唯一的n位地址，为了与Cache映射，将主存与缓存都分成若干块，每块包含若干个字

![image-20210514005225475](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514005225475.png)

- 主存的地址分成两端，高m位表示主存的块地址，低b位表示块内地址
- 缓存的地址分成两端，高c位表示缓存的块号，低b位表示块内地址
- C远小于M

任何时刻都有一些主存块在缓存块中，CPU欲读取主存某字时，有两种可能

- 所需要的字已在缓存中，可直接访问Cache（访问Cache命中）
- 所需的字不在缓存中，需将该字所在的主存整个字块一次调入Cache中（访问Cache不命中）
- 如果主存块已调入缓存块，则称主存块与缓存块之间建立了对应关系

缓存块数远小于主存块数，故一个缓存块对应多个主存块，而一个主存块只对应一个缓存块，用**标记**表示当前存放的是哪一个主存块

Cache的容量与块长是影响Cache效率的重要因素，通常用命中率来衡量Cache的效率

**公式**

在一个程序执行器件，`Nc为访问Cache的总命中次数`，`Nm为访问主存的总次数`，则命中率h为
$$
h = \frac{N_c}{N_c+N_m}
$$
设tc为命中时的Cache访问时间，tm为未命中时的平均访问时间，1-h表示未命中率，则Cache-主存系统的平均访问时间tc为
$$
t_a = ht_c+(1-h)t_m
$$
当然，以较小的硬件代价使Cache-主存系统的平均访问时间ta越接近于tc越好，用e表示访问效率，则有
$$
e = \frac{t_c}{t_a}\times100= \frac{t_c}{ht_c+(1-h)t_m}\times100
$$
**一般而言，Cache容量越大，CPU命中率越高，容量过大增加成本，而且到达一定值时，再增大容量，命中率不会明显提高**

块长与命中率的关系更为复杂，局部性原理得出，在已被访问字的附近，近期也可能被访问。因此，增大块长，可将更多有用字存入缓存，提高其命中率。

但是，块长过大，命中率反而下降，这是因为所装入缓存的数据反而少于被替换掉的有用数据。块长太大，导致装入缓存的块数变少，Cache需要覆盖旧块，可能导致刚进去的块没多久就被覆盖掉

#### （3）Cache的基本结构

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514110448635.png" alt="image-20210514110448635" style="zoom: 80%;" />

它主要由Cache存储体、地址映射机构、Cache替换机构几大模块组成

（1）Cache存储体

- Cache存储体以块为存储单位与主存交换信息，为加速Cache与主存之间的调用，主存大多采用多体结构，且Cache访存的优先级最高

（2）地址映射变换机构

- 地址映射变换机构将CPU送来的主存地址转换为Cache地址
- 地址变换主要是主存的块号（高位地址）与Cache块号间的转换
- 转换后的Caceh块已与CPU欲访问的主存块建立了对应关系，则已命中，CPU可以之间访问Cache存储体
- 转换后的Caceh块与CPU欲访问的主存块没有建立对应关系，则未命中，CPU访问主存时，不仅将该字取出，同时将它所在的主存块一并调入Cache，供CPU使用（未装满状态，装满的话需采用替换策略）

（3）替换机构

- 当Cache内容已满，由Cache的替换机构按一定的替换算法来确定应从Cache内部移出哪一个块返回内存

（4）Cache的读写操作

![image-20210514111130523](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514111130523.png)

**读操作**

- 当CPU发出主存地址后，首先判断该存储字是否在Cache中，若命中，直接访问Cache，将该字送至CPU；若未命中，一方面要访问内存，将该字传送给CPU，于此同时，将改字的主存块装入Cache

**写操作**

- 较为复杂，对Cache内写入的信息，必须与被映射的主存块内的信息完全一致
- 写直达法：写操作时数据既写入Cache又写入主存，随时保证主存和Cache的数据一致，但是增加了访问次数
- 写回法：写操作时只写入Cache，但当Cache数据被替换出去时才写回主存，写回法主存和Cache的数据会不一致，为了识别Cache的数据和主存的数据，Cache的每一块要增设一个标志位，该位两个状态，“清”（未修改）和“浊”（已修改），Cache替换时，“清”的Cache块不必写回主存，“浊”的需要，在写Cache时，需将标志位设置为“浊”，替换时将Cache写回主存，标志位设置为“清”
- 写回法，写操作时只写入Cache，写操作时间就是访问Cache的时间，速度块，且可减少主存的写操作次数，但增加了Cache的复杂性，对于多个处理器的系统，各自都有独立的Cache，更改了一个Cache和主存，其余的Cache没有更改，数据不一致，写直达法也无法改变其他主存的数据，这就是Cache一致性问题

#### （4）Cache的改进

Cache刚出现，典型系统只有一个缓存，现在普遍采用多个Cache，增加Cache的级数，将统一的Cache变成分立的Cache

**单一缓存和两级缓存**

单一缓存：在CPU和主存之间只设一个缓存

这个缓存直接与CPU制作在同一个芯片上，又称片内缓存，可提高外部总线的利用率。因为Cache直接制作在芯片内，CPU直接访问不必占用芯片外的系统总线，而且片内缓存与CPU之间的数据通路很短，大大提高了存取速度，外部总线就更多支持I/O设备与主存的信息传输，增强了系统的整体效率

缺点：在芯片内部设置，容量不会很大，最后肯定会超出，然后访问外部的总线访问主存，降低整机的速度

解决：在片内缓存和主存之间加一层片外缓存（比动态RAM和ROM存取速度更快的静态RAM），而且不用系统总线作为片外缓存与CPU之间的传送路径，而是使用一个独立的数据路径，减轻系统总线的负担

**这种由片外缓存和片内缓存组成的Cache称为两级缓存**

**同一缓存和分立缓存**

### Cache——主存地址映射

#### （1） 直接映射

![image-20210514115748297](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514115748297.png)

- 每个主存块只与一个缓存块相对应，一个缓存块对应多个主存块
- 主存地址高m位分成了两部分，低c位只Cache的字块地址，高t位指主存字块标记，当缓存接到CPU的主存地址后，只需根据中间的c位字段找到Cache子块1，然后根据字块1的“标记”是否与主存地址的高t位相符来判断，若符合且有效位1（有效位识别Cache的数据是否有效，有时候Cache的数据无效），表示该Cache块已和主存的某块建立了对应关系
- 若不符合或有效位为0，则从主存读入新的字块来代替旧的字块，同时将信息送入CPU，并修改Cache标记
- 直接映射还是不够灵活，每个主存块只能固定存入某个缓存块，即使别的缓存块空闲也不能被利用，浪费了存储资源

#### （2）全相联映射

- 允许主存中每一个字块映射到Cache任何一块位置
- 这种映射方式可以从已被占满的Cache中替换出任一旧字块
- 灵活，命中率高，缩小了块冲突率
- 与直接映射相比，主存字块标记从t为增加到了t+c位，使Cache标记的位数增多，而且访问Cache时主存字块标记需要和Cache的全部标记进行比较
- 逻辑电路多，成本高

![image-20210514120928782](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514120928782.png)

#### （3）组相联映射

- 对直接映射和全相联映射的折中
- 把Cache分为几组，每组几块，每个主存字块直接映射到某个固定组，但是可以在组里的任意一个字块内
- 比如主存的第0、16、32字块可以映射到Cache第0组2个字块中的任一字块

![image-20210514122012758](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210514122012758.png)

### 替换策略

- 先进先出算法
- 近期最少使用算法

## 辅助存储器

