[TOC]



# CPU的结构和功能

从分析CPU的功能和内部入手，详细讨论机器完成一条指令的全过程

## CPU的结构

### CPU的功能

CPU包括运算器和控制器两大部分，重点介绍控制器的功能

控制器：负责协调并控制计算机各部件执行程序的指令序列，其基本功能是取指令、分析指令和执行指令

**取指令**

- 控制器必须具备能自动从存储器中取出指令的功能，要求控制器能自动形成指令的地址，并能发出取指令的命令，将相应指令取到控制器中

**分析指令**

- 分析指令要完成什么操作，即控制器需发出什么操作命令
- 分析参与这次操作的操作数地址，即操作数的有效地址

**执行命令**

- 根据分析指令产生的操作命令和操作数地址的要求，形成操作控制信号序列

- 控制器还必须能控制程序的输入和运算结果的输出以及对总线的管理
- 处理中断的能力

### CPU结构框图

- 要取指令，必须有一个寄存器专用于存放当前指令的地址
- 要分析指令，必须有存放当前指令的寄存器和对指令操作码进行译码的部件
- 要执行指令，必须有一个能发出各种操作命令序列的控制部件CU
- 要完成算术运算和逻辑运算，必须有存放操作数的寄存器和实现算逻运算的部件ALU
- 要处理特殊情况，还要有中断系统

![image-20210521120121481](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521120121481.png)

### CPU的寄存器

CPU寄存器分两类

- 用户可见寄存器，用户可对这类寄存器编程，以及通过优化CPU因使用这类寄存器而减少对主存的访问次数
- 控制而状态寄存器，用户不可对这类寄存器编程，它们被控制部件使用，以控制CPU的操作，也可被带有特权的操作系统程序使用

**用户可见寄存器**

（1）通用寄存器

- 可由设计者指定许多功能，可用于存放操作数，也可作为满足某种寻址方式的寄存器

（2）数据寄存器

- 存放操作数，有些机器允许使用两个连续的寄存器存放双倍字长的值

（3）地址寄存器

- 存放地址

（4）条件码寄存器

- 存放条件码，条件码是CPU根据运算结果由硬件设置的位。例如算术运算会产生正、负、零、或溢出等结果
- 条件码可被测试，作为分支运算的依据

在调用子程序前，必须将所有的用户可见寄存器的内容保存起来

**控制和状态寄存器**

- MAR：存储器地址寄存器
- MDR：存储器数据寄存器
- PC：程序计数器，存放现行指令的地址，具有计数功能，遇到转移指令，PC的值可被修改
- IR：指令寄存器，存放当前欲执行的指令

通过这4个寄存器，CPU可以和主存交换信息。例如，将现行指令地址从PC送至MAR，启动存储器作读操作，存储器就可将指定地址单元内的指令读至MDR，再由MDR送至IR

### 控制单元和中断系统

控制单元CU提供完成计算机全部指令操作的微操作命令序列部件

## 指令周期

### 指令周期的基本概念

CPU每取出并执行一条指令所需的全部时间称为指令周期，也即CPU完成一条指令的时间

- 取值阶段完成取指令和分析指令的操作，又称取值周期
- 执行阶段完成执行指令的操作，又称执行周期
- 不同指令的指令周期不一样
  - 条件转移指令在执行阶段不需要访问主存，可以在取值阶段后将转移地址X送至PC，这样指令周期就是取值周期
  - 如加法指令，需要从存储单元取出操作数，与ACC内容相加，结果存于ACC，取指和执行都要访问内存，其指令周期包括两个存取周期
  - 乘法指令，其执行阶段完成的操作比加法指令多得多，所以执行周期长

![image-20210521142834038](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521142834038.png)

遇到间接寻址的指令，指令字只给出操作数有效地址的地址，获取操作数还得访问一次存储器，取出有效地址，再访问存储器，取出操作数

间接寻址的指令周期就包括取指周期、间址周期和执行周期3个阶段

![image-20210521143932166](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521143932166.png)

### 指令周期的数据流

分析指令周期中的数据流，假设CPU中有存储器地址寄存器MAR、存储器数据寄存器MDR、程序计数器PC和指令寄存器IR

**取指周期的数据流**

![image-20210521144702311](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521144702311.png)

![image-20210521162426472](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521162426472.png)

**间址周期的数据流**

![image-20210521144801317](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521144801317.png)

![image-20210521171805693](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521171805693.png)

**执行周期的数据流**

![image-20210521171811013](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521171811013.png)

**中断周期的数据流**

![image-20210521144805674](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521144805674.png)

## 指令流水

提升效率速度，需改进系统的结构，开发系统的并行性

并行，包含同时性和并发性两个方面

同时性：在同一时刻发生

并发性：在同一时间段发生

### 指令流水原理

![image-20210521172125686](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521172125686.png)

指令部件工作，执行部件基本空闲，如果指令执行阶段不访问主存，则完全可以利用这段时间取下一条指令，这样就使取下一条指令的操作和执行当前指令的操作同时进行

![image-20210521172225716](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521172225716.png)

### 影响流水线性能的因素

流水过程中会出现三种相关，使流水线不断流实现起来困难，分别是结构相关、数据相关和控制相关

**结构相关**

当指令在重叠执行中，不同指令争用同一功能部件产生资源冲突时产生的

解决方法

- 可以让流水线完成前一条指令对数据的存储器访问时，暂停取后一条指令的操作
- 设置两个独立的存储器分别存放操作数和指令，以免取指令和取操作数同时进行互相冲突

**数据相关**

- 流水线中各条指令因重叠操作，可能改变对操作数的读写访问顺序，从而导致了数据相关冲突（比如前一个指令的结果需要后一个指令用到，结果现在同时执行了，就会出错）
- 采用后推法，遇到数据相关时，就停顿后继指令的运行，直至前面的结果已经生成

**控制相关**

主要由转移指令引起，转移指令约占总指令的四分之一，会使流水线丧失更多的性能，转移发生会使流水线的连续流动遭到破坏

![image-20210521173747933](C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521173747933.png)

### 流水线性能

吞吐率、加速比和效率三个指标衡量

## 中断系统

之前介绍了一些有关中断的概念，比如I/O设备中断，不过这只是CPU众多中断的一种，为了处理各种中断，CPU内部通常设有中断系统

### **概述**

引起中断的各种因素

- 人为设置的中断
- 程序性事故：定点溢出、浮点溢出、操作码不能识别
- 硬件故障：插件接触不良等
- I/O设备：准备就绪后，想CPU发出中断请求
- 外部时间：用户通过键盘来中断现行程序

中断系统需解决的问题

- 各中断源如何向CPU提出中断请求
- 当多个中断源同时提出中断请求时，中断系统如何确定优先相应哪个中断源的请求
- CPU在什么条件、什么时候、以什么方式来相应中断
- CPU相应中断后如何保护现场
- CPU相应中断后，如何停止原程序的执行而转入中断服务程序的入口地址
- 中断处理结束后，CPU如何恢复现场，如何返回到原程序的间断处
- 在中断处理过程中又出现了新的中断请求，CPU该如何处理

### 中断请求标记和中断判优逻辑

**中断请求标记**

- 为判断是哪个中断源提出请求，中断系统中必须设置中断请求标记触发器，简称中断请求触发器，记作INTR，状态为1，表示中断源有请求

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521225744583.png" alt="image-20210521225744583" style="zoom:80%;" />

**中断判优逻辑**

- 任何一个中断系统，在任一时刻，只能响应一个中断源的请求，某一时刻多个中断源提出请求，中断系统必须按其优先顺序予以响应，这叫做中断判优
- 中断判优可由硬件实现，也可由软件实现

硬件排队

- 一种为链式排队器
- 另一种排队其设在CPU内，高优先级中断源有请求时，会封住比它等级低的中断源的请求

软件排队

- 通过编写程序实现，程序按优先等级，从高到底的访问查询各中断源是否有中断请求

### 中断服务程序入口地址的寻找

硬件向量法

- 利用硬件产生向量地址，再由向量地址找到中断服务程序的入口地址

软件查询法

- 当查到某一中断源有中断请求时，接着安排一条转移指令，直接指向此中断源的中断服务程序入口地址，机器便能自动进入中断处理

### 中断响应

响应中断的条件

- 中断触发器必须为1，在中断系统中有一个允许中断触发器EINT，它可被开中断指令置1，也可被关中断指令置0

响应中断的时间

- CPU总是在指令执行周期结束后，响应任何中断源的请求，因为CPU在执行周期的结束时刻统一查询所有中断源发中断查询信号

中断隐指令

CPU响应中断后，即进入中断周期，CPU要自动完成一系列操作

- **保护程序断点：**将PC的内容保存到存储器中，可以存在存储器的特定单元，也可以存入堆栈
- **寻找中断服务程序的入口地址：**中断周期结束后进入下条指令，因此只能孤单周期后必须找到中断服务程序的入口地址
- **关中断：**为了确保CPU响应后所需做的一系列操作不被新的中断请求干扰，中断周期内必须关中断

### 保护现场和恢复现场

保护现场包括**保护程序断点**和**保护CPU内部各寄存器内容**的现场两个方面

### 中断屏蔽计数

主要用于多重中断

**多重中断的概念**

CPU正在执行某个中断服务程序时，另一个中断源提出了新的中断请求，**而CPU响应了这个请求**，暂时停止正在运行的服务程序，转去执行新的中断服务程序，这称为多重中断

**实现多重中断的条件**

- 提前设置开中断指令
- 优先级别高的中断源有权中断优先级别低的中断源

**屏蔽技术**

CPU接收不带该中断源的中断请求，即它被屏蔽

<img src="C:\Users\LENOVO\AppData\Roaming\Typora\typora-user-images\image-20210521232744221.png" alt="image-20210521232744221" style="zoom:80%;" />

屏蔽技术可改变优先级

**多重中断的断点保护**

多重中断时，每次中断出现的断点都需保存起来

断点可以保存在堆栈中，先进后出

